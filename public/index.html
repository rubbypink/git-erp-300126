<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>9 Trip Phu Quoc ERP @2026</title> 
  <link rel="icon" type="image/png" href="./src/images/favicon.png?v=2">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  
  <link rel="stylesheet" href="./src/css/main.css">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <div class="app-container" style="opacity: 0; transition: opacity 0.9s;" id="main-app">
    <div class="app-header container-fluid shadow-sm p-2 my-0 border-bottom">
        <div class="row d-inline-flex justify-content-center w-100">
              <div class="col-md-5 pb-0" style="position: relative;">
                <ul class="nav nav-tabs px-1 rounded" id="mainTabs" role="tablist">                  
                  <li class="nav-item">
                    <button class="nav-link active fw-bold" 
                            data-bs-target="#tab-dashboard"                            
                            onclick="activateTab('tab-dashboard')">
                      <i class="fa-solid fa-chart-line text-primary"></i> Dashboard
                    </button>
                  </li>
                  <li class="nav-item">
                    <button class="nav-link" 
                            data-bs-target="#tab-form" 
                            onclick="activateTab('tab-form')">
                      Booking
                    </button>
                  </li>
                  <li class="nav-item">
                    <button class="nav-link" 
                            data-bs-target="#tab-list" 
                            onclick="activateTab('tab-list')">
                      Full Data
                    </button>
                  </li>
                  <li class="nav-item d-none" data-ontabs="4">
                    <button class="nav-link text-info"
                            data-bs-target="#tab-sub-form" 
                            onclick="activateTab('tab-sub-form')">
                      <i class="fa-solid fa-user-tag"></i> Khách hàng
                    </button>
                  </li>
                  <li class="nav-item admin-only">
                    <button class="nav-link" 
                            data-bs-target="#tab-log" 
                            onclick="activateTab('tab-log')">
                      Admin Log
                    </button>
                  </li>

                  <li class="nav-item admin-only">
                    <button class="nav-link text-danger" 
                            data-bs-target="#tab-admin-dashboard" 
                            onclick="activateTab('tab-admin-dashboard')">
                      <i class="fa-solid fa-user-shield"></i> Admin
                    </button>
                  </li>
                </ul>
              </div>
              <div class="col-md-4 d-flex justify-content-between align-items-center mx-auto">
                <h5 class="m-0 text-white fw-bold text-uppercase d-inline-flex justify-content-center" style="letter-spacing: 1px; font-size: 1.5rem;">
                  <img id="main-logo" src="https://9tripvietnam.com/wp-content/uploads/2019/05/Logo-9-trip.png.webp" class="bg-white rounded-circle p-1 me-3 main-logo" alt="..." style="height: 2rem; width: 2rem;">
                  QUẢN LÝ BOOKING
                  <i class="fa-solid fa-rotate-right ms-3 admin-only" style="cursor: pointer; font-size: 0.9em;" onclick="reloadPage()" title="Reload"></i>
                </h5>
              </div>
              <div class="col-md-3" id="header-filters">
                <div class="d-flex justify-content-end gap-1 align-items-center">
                      <div class="d-flex col-auto d-none" id="datalist-select" data-ontabs="3">
                        <select id="btn-select-datalist" class="form-select form-select-sm" style="max-width: 120px;"></select>
                      </div>
                      <div class="dropdown d-none" id='btn-group-download' data-ontabs="3">
                        <button class="btn btn-warning btn-sm dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" id="download-menu">
                          Tải File
                        </button>
                        <div class="dropdown-menu" aria-labelledby="download-menu">
                          <button class="dropdown-item" type="button" onclick="downloadData()">File Exel</button>
                          <button class="dropdown-item" type="button" onclick="downloadData('pdf')">File PDF</button>
                        </div>
                      </div>
            
                      <div id="search-area" class="flex-center d-none" data-ontabs="1 2">
                        <div class="input-group input-group-sm gap-1">
                          <input type="text" id="global-search" class="form-control" placeholder="Tìm kiếm...">
                          <div class="input-group-append gap-1">
                            <button class="btn btn-sm btn-outline-primary" type="button" onclick="handleSearchClick()">
                              <i class="fa-solid fa-search"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                          <i class="fa-solid fa-gear text-secondary"></i><span class="fw-bold text-secondary">Hệ Thống</span>
                        </button>

                        <ul class="dropdown-menu px-1 animate__animated animate__fadeIn">
                          <li><button class="dropdown-item btn-sm d-flex align-items-center gap-2" onclick="reloadPage()"><i class="fa-solid fa-rotate text-primary" style="width:20px"></i> Reload ERP</button></li>
                          <li><button class="dropdown-item btn-sm d-flex align-items-center gap-2" onclick="loadDataFromFireBase()"><i class="fa-solid fa-skull" style="width:20px"></i> Cập Nhật Dữ Liệu Mới</button></li>
                          <li><button class="dropdown-item btn-sm d-flex align-items-center gap-2" onclick="toggleFullScreen()"><i class="fa-solid fa-expand" style="width:20px"></i> Toàn Màn Hình</button></li>
                          <li><hr class="dropdown-divider"></li>
                          <li class="admin-only bg-secondary bg-opacity-50">
                            <button class="dropdown-item btn-sm d-flex align-items-center gap-2" onclick="openSettingsModal()">
                              <i class="fa-solid fa-sliders text-success" style="width:20px"></i> Cài Đặt
                            </button>
                          </li>
                          <li class="admin-only">
                            <a class="dropdown-item btn-sm d-flex align-items-center gap-2" 
                              href="https://docs.google.com/spreadsheets/d/176ik2ueN6UvUFbjrmrIag2tJY18hgbAqUPhDInG7cdo/edit?gid=888235904#gid=888235904" 
                              target="_blank" 
                              rel="noopener noreferrer">
                              <i class="fa-solid fa-external-link-alt text-primary" style="width:20px"></i>Mở Operator Database
                            </a>
                            <a class="dropdown-item btn-sm d-flex align-items-center gap-2" 
                              href="https://docs.google.com/spreadsheets/d/1E54Ibp0WvH2c4fFEbXdneuxSLK_qc6ClV2qwQM7AFMw/edit?gid=1052080251#gid=1052080251" 
                              target="_blank" 
                              rel="noopener noreferrer">
                              <i class="fa-solid fa-external-link-alt text-primary" style="width:20px"></i>Mở Sales Database
                            </a>
                            <a class="dropdown-item btn-sm d-flex align-items-center gap-2" 
                              href="https://script.google.com/home/projects/1Nthq68r_ZRPbkP7d8FChIxn6_29YSkDTDJpM9o2EKFGSof9xncAeeJcx/edit" 
                              target="_blank" 
                              rel="noopener noreferrer">
                              <i class="fa-solid fa-external-link-alt text-primary" style="width:20px"></i>Mở Mã Nguồn GAS
                            </a>
                            <a class="dropdown-item btn-sm d-flex align-items-center gap-2"
                              href="https://console.firebase.google.com/u/0/project/trip-erp-923fd/firestore"
                              target="_blank" rel="noopener noreferrer">
                              <i class="fa-solid fa-external-link-alt text-primary" style="width:20px"></i>Mở Mã Nguồn FB
                            </a>
                            <hr class="dropdown-divider">
                            <button class="dropdown-item btn-sm d-flex align-items-center gap-2 text-warning" onclick="clearLocalCache()">
                              <i class="fa-solid fa-trash text-warning" style="width:20px"></i>Xóa Local Cache
                            </button>
                            <button id="btn-batch-create-data" class="dropdown-item btn-sm d-flex align-items-center gap-2 text-warning">
                              <i class="fa-solid fa-sign-in-alt text-warning" style="width:20px"></i>Batch New Data
                            </button>                            
                          </li>
                        </ul>
                      </div>
                      <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown">
                          <i class="fa-solid fa-user text-info"></i><span class="fw-bold text-info" id="user-menu-text"></span>
                        </button>
                        
                        <ul class="dropdown-menu px-1 animate__animated animate__fadeIn" id="user-menu">
                          <li id="user-info-card" class="px-2 py-2 border-bottom">
                            <div class="text-muted small">
                              <div><strong id="user-menu-name"></strong></div>
                              <div id="user-menu-email" style="font-size: 0.85rem;"></div>
                              <div><span class="badge bg-secondary" id="user-menu-role">-</span></div>
                            </div>
                          </li>
                          <li><button class="dropdown-item btn-sm d-flex align-items-center gap-2" id="btn-logout-menu" onclick="AUTH_MANAGER.signOut()" style="display:none;"><i class="fa-solid fa-sign-out-alt text-danger" style="width:20px"></i> Đăng Xuất</button></li>
                          <li><button class="dropdown-item btn-sm d-flex align-items-center gap-2" id="btn-login-menu" onclick="AUTH_MANAGER.showLoginForm()"><i class="fa-solid fa-sign-in-alt text-primary" style="width:20px"></i> Đăng Nhập</button></li>
                          <li class="manager-only">
                          <select id="btn-select-masked-role" 
                                    class="form-select form-select-sm fw-bold text-primary" 
                                    style="max-width: 120px;"
                                    onchange="reloadSystemMode(this.value);">
                              <option value="sale">Sales Mode</option>
                              <option value="op">Operator Mode</option>
                            </select>
                          </li>
                        </ul>
                      </div>                      
                    </div>
              </div>
        </div>
    </div>
    <div class="app-content px-1">
      <div class="tab-content px-1" id="main-tab-content"> 
        <div class="tab-pane fade show active" id="tab-dashboard"></div>
        <div class="tab-pane fade" id="tab-form"></div>
        <div class="tab-pane fade m-1" id="tab-list"></div>
        <div class="tab-pane fade" id="tab-sub-form"></div>
        <div class="tab-pane fade admin-only" id="tab-admin-dashboard"></div>
        <div class="tab-pane fade admin-only" id="tab-log"></div>
      </div>
    </div>

    <div class="footer-bar p-2 gap-2 bg-light bg-opacity-75 justify-content-center" id="main-footer">
      <div class="btn-group gap-2 sales-only">
        <button id="btn-new-bk" 
              class="btn btn-primary" 
              data-bs-target="#tab-form" data-ontabs="1 3 4" 
              onclick="activateTab('tab-form')">
        <i class="fa-solid fa-plus-circle"></i> Tạo Booking
        </button>
        <button class="btn btn-info" data-ontabs="1 2" onclick="activateTab('tab-sub-form')"><i class="fa-solid fa-user-plus"></i> Tạo Khách Hàng</button>
      </div>
      <div class="btn-group gap-2 op-only">
        <button id="btn-request-rates" 
              class="btn btn-primary" 
              onclick="PartnerMailModule.open()">
        <i class="fa-solid fa-palette"></i> Gửi Yêu Cầu Báo Giá
        </button>
        <button id="btn-hotel-rate-plans" 
              class="btn btn-primary" >
        <i class="fa-solid fa-triangle-exclamation"></i> Quản lý Giá Hotel
        </button>   
        <button id="btn-service-rate-plans" 
              class="btn btn-primary" >
        <i class="fa-solid fa-plus-circle"></i> Quản lý Giá Dịch Vụ
        </button>                
      </div>      
      <div id="btn-group-bk" class="btn-group gap-2">
        <button id="btn-create-contract" data-ontabs="2 4" class="btn btn-warning line-clamp-2 sales-only" onclick="createContract()"><i class="fa-solid fa-print"></i> Tạo Hợp Đồng</button>
        <button id="btn-save-batch" class="btn btn-warning fw-bold d-none line-clamp-2" data-ontabs="" onclick="saveBatchDetails()"><i class="fa-solid fa-check-double"></i> Lưu Theo (List)</button>
        <button id="btn-save-form" class="btn btn-success" onclick="saveForm()" data-ontabs="2"><i class="fa-solid fa-save"></i> Lưu Booking </button>
        <button class="btn btn-danger sales-only" onclick="logA('CẢNH BÁO: Hủy Booking?', 'danger', deleteForm)" data-ontabs="2"><i class="fa-solid fa-trash"></i> Hủy Booking</button>
        <button id="btn-reset-form" class="btn btn-danger" data-ontabs="2" onclick="logA('Xóa hết dữ liệu vừa nhập ?', 'warning', refreshForm)"><i class="fa-solid fa-rotate"></i> Xóa Form</button>
      </div>
  
    </div>
  </div>

  <div id="notification-banner" class="alert position-absolute top-90 start-50 translate-middle text-center text-wrap align-items-center fw-bold fs-5 shadow d-none"
   style="z-index: 9999; max-width: 600px; cursor: pointer; bottom: 5vh;" onclick="this.classList.add('d-none')"></div>
  <div class="context-menu dropdown-menu shadow" id="myContextMenu" style="display: none; position: fixed;">
    <button class="dropdown-item gap-2 d-flex align-items-center btn-sm btn-light" id="ctx-copyData">
      <i class="fa-solid fa-copy text-primary" style="width:20px"></i>
      <span>Copy Data Hàng</span>
    </button>
    
    <button class="dropdown-item gap-2 d-flex align-items-center btn btn-sm btn-secondary" id="ctx-paste">
      <i class="fa-solid fa-paste text-success" style="width:20px"></i>
      <span>Dán Data Hàng</span>
    </button>
    <button class="dropdown-item gap-1 d-flex align-items-center btn btn-sm btn-light" id="ctx-copy"><i class="fa-solid fa-copy text-primary" style="width:15px"></i> Copy Hàng Này</button>
    <div class="dropdown-divider"></div>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item gap-1 d-flex align-items-center text-danger btn btn-sm btn-primary" id="ctx-save-one"><i
        class="fa-solid fa-save" style="width:15px"></i>Lưu Hàng Hiện Tại</button>
    <button class="dropdown-item gap-1 d-flex align-items-center text-danger btn btn-sm btn-light" id="ctx-delete"><i class="fa-solid fa-trash" style="width:15px"></i> Xóa Hàng (Database)</button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item gap-1 d-flex align-items-center text-danger btn btn-sm btn-light" id="ctx-delete-bk"><i class="fa-solid fa-trash" style="width:15px"></i>Xóa Booking (Database)</button>    
  </div>
  <div id="custom-overlay" class="position-fixed top-0 start-0 w-100 h-100" style="display: none; z-index: 9999; background-color: rgba(0,0,0,0.6);"> 
    <div class="position-absolute top-50 start-50 translate-middle bg-white bg-opacity-75 border border-dark rounded-3 shadow-lg overflow-hidden" style="min-width: 25vw; max-height: 55vh;">
      <div id="custom-overlay-header" class="d-flex justify-content-between align-items-center px-3 py-1 border-bottom">
        <h6 class="m-1 text-center text-dark" id="overlay-title">THÔNG BÁO</h6>
        <button type="button" class="btn-close small" onclick="closeOverlay()"></button>
      </div>
      <div class="p-2 w-100 overflow-auto" id="overlay-body" style="max-height: 40vh;"></div>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-2" style="font-size: 0.75rem; max-width: 15vw; max-height:50vh; z-index: 11000;">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
      <div class="toast-header">
        <img src="https://9tripvietnam.com/wp-content/uploads/2019/05/Logo-9-trip.png.webp" class="rounded me-2" alt="..." style="height: 20px; width: 20px;">
        <strong class="me-auto">Thông Báo</strong>
        <small id="toast-time-calc">1 mins ago</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div id="toast-body" class="toast-body text-wrap">
      </div>
    </div>
  </div>
  <at-modal-full title="Full Modal"></at-modal-full>
  <template id="tmpl-dynamic-modal">
    <div class="modal fade modal-fit-content" id="dynamic-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content shadow-lg border-0">
          <div class="modal-header bg-primary bg-gradient text-white py-2">
            <h6 class="modal-title fw-bold text-uppercase">
              <i class="fa-solid fa-sliders me-2"></i>My Modal
            </h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="btn-x-modal"></button>
          </div>

          <div id="dynamic-modal-body" class="modal-body p-0 bg-light"></div>

          <div class="modal-footer bg-gray p-2 m-2 gap-2">
            <button id="btn-reset-modal" type="button" class="btn btn-secondary">
              Reset
            </button>
            <button id="btn-save-modal" type="submit" class="btn btn-primary px-4 fw-bold" >
              <i class="fa-solid fa-check me-2"></i>Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>
  <offcanvas-left-menu id="leftMenuComponent"></offcanvas-left-menu>
  <script>
    // Bạn cần Deploy file .gs thành Web App và dán URL vào đây
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby_54qWXvDLG3Jm6s-jAH75S6dO1L6X1rmHrnqJ5I2CQBw4QQa1t3u4QKcEA98kI8qV/exec"; 
    var CURRENT_USER = {
      role: 'sale',
      email: '',
      level: 1,
      maskedRole: '',
      profile: {}
    };
    var ADMIN_EMAILS = ['tranthuaanh90@gmail.com', '9tripphuquoc@gmail.com'];
    var JS_MANIFEST = {
      sale: ['logic_sales.js', 'api_sales.js'],
      op: ['logic_operator.js', 'api_operator.js']
    };
    var TEMPLATE_MANIFEST = {  
      base: ['tmpl-dashboard', 'tmpl-form'],    
      sale: ['tmpl-sub-form', 'tmpl-confirmation-modal'],
      op: ['tmpl-partner-mail']
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="./src/js/common/components/offcanvas_left.js"></script>
  <script src="./src/js/common/components/offcanvas-left-init.js"></script>  
  <script src="./src/js/utils.js"></script>
  <script src="./src/js/db_schema.js"></script> <script src="./src/js/db_manager.js"></script>
  <script src="./src/js/shortkey.js"></script>
  <script src="./src/js/login_module.js"></script>
  <script src="./src/js/renderer.js"></script>
  <script src="./src/js/logic_base.js"></script>
  <script src="./src/js/api_base.js"></script>
  <script src="./src/js/events.js"></script>
  <script type="module" src="./src/js/app.js"></script>
</body>
</html>